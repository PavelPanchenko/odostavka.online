name: Fresh Deploy to Production

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Fresh Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
          set -e
          echo "üöÄ Starting fresh deployment..."
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          echo "üßπ Cleaning old deployment..."
          rm -rf ${{ secrets.SERVER_PATH }}
          mkdir -p ${{ secrets.SERVER_PATH }}
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∑–∞–Ω–æ–≤–æ
          echo "üì• Cloning repository..."
          cd ${{ secrets.SERVER_PATH }}
          git clone https://PavelPanchenko:${{ secrets.GITHUB_TOKEN }}@github.com/PavelPanchenko/odostavka.online.git .
          
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
          echo "‚öôÔ∏è Creating .env file..."
          cp env.example .env
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üõë Stopping old services..."
          docker-compose down || true
          
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã
          echo "üî® Building images..."
          docker-compose build --no-cache
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
          echo "üöÄ Starting services..."
          docker-compose up -d
          
          # –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
          echo "üßπ Cleaning up..."
          docker system prune -f
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä Checking service status..."
          docker-compose ps
          
          echo "‚úÖ Fresh deployment completed successfully!"
        '
        
    - name: Health check
      run: |
        echo "üè• Performing health checks..."
        sleep 30
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
        if curl -f -s https://api.${{ secrets.DOMAIN || 'odostavka.online' }}/health > /dev/null; then
          echo "‚úÖ API health check passed"
        else
          echo "‚ö†Ô∏è API health check failed"
        fi
